<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <title>श्री शांतिनाथ दिगम्बर जैन मंदिर</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Devanagari:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #6B2D5C;
      --accent-color: #D1A33F;
      --text-color: #2D3748;
      --background-color: #F9FAFB;
      --card-bg: #FFFFFF;
      --modal-bg: linear-gradient(145deg, #FFFFFF, #F5F7FA);
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: 'Noto Serif Devanagari', 'Inter', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 50;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal-content {
      background: var(--modal-bg);
      margin: 1.5rem auto;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: var(--shadow-md);
      width: 95%;
      max-width: 500px;
      min-width: 300px;
      position: relative;
      border: 2px solid var(--accent-color);
      animation: slideUp 0.3s ease-in-out;
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal-close {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary-color);
      cursor: pointer;
      transition: color 0.2s, transform 0.2s;
    }
    .modal-close:hover {
      color: var(--accent-color);
      transform: scale(1.1);
    }
    #shareWhatsAppBtn {
      position: absolute;
      top: 0.75rem;
      right: 2.75rem;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--primary-color);
      border-radius: 50%;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.2s;
    }
    #shareWhatsAppBtn:hover {
      background-color: #5A204A;
      transform: scale(1.1);
    }
    #shareWhatsAppBtn .share-icon {
      width: 1.25rem;
      height: 1.25rem;
      object-fit: contain;
      filter: brightness(0) invert(1);
    }
    .modal-header {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--accent-color);
      margin-bottom: 1rem;
      gap: 0.75rem;
      max-width: 90%;
      margin-left: auto;
      margin-right: auto;
    }
    .modal-header .logo-placeholder {
      width: 2.75rem;
      height: auto;
      object-fit: contain;
    }
    .modal-header .center-text-wrapper {
      display: flex;
      justify-content: center;
      flex: 1;
    }
    .modal-header .text-container {
      display: flex;
      flex-direction: column;
      text-align: center;
      max-width: 80%;
    }
    .modal-header .spacer {
      width: 2.75rem;
    }
    .modal-header h2 {
      font-size: clamp(1.25rem, 4.5vw, 1.5rem);
      font-weight: 600;
      color: var(--primary-color);
      margin: 0;
      line-height: 1.3;
    }
    .modal-header p {
      font-size: clamp(0.75rem, 3vw, 0.875rem);
      color: #6B7280;
      margin: 0.25rem 0 0;
    }
    .modal-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      padding: 1rem 0;
      max-width: 90%;
      margin-left: auto;
      margin-right: auto;
    }
    .modal-details p {
      margin: 0;
      font-size: clamp(0.8rem, 3.2vw, 0.9rem);
      color: var(--text-color);
      display: flex;
      justify-content: space-between;
    }
    .modal-details p span:first-child {
      font-weight: 500;
      color: var(--primary-color);
      font-size: clamp(0.7rem, 2.8vw, 0.8rem);
      text-align: left;
    }
    .modal-details p span:last-child {
      color: var(--text-color);
      font-weight: 600;
      text-align: right;
    }
    .modal-footer {
      text-align: center;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #E5E7EB;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-width: 90%;
      margin-left: auto;
      margin-right: auto;
    }
    .modal-footer p {
      font-size: clamp(0.7rem, 2.8vw, 0.8rem);
      color: #6B7280;
      margin: 0;
    }
    .error-text {
      color: #DC2626;
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }
    @media (max-width: 640px) {
      .modal-content {
        padding: 1rem;
        margin: 1rem auto;
        border-radius: 0.75rem;
      }
      .modal-close {
        top: 0.5rem;
        right: 0.5rem;
        font-size: 1rem;
      }
      #shareWhatsAppBtn {
        top: 0.5rem;
        right: 2.25rem;
        width: 1.75rem;
        height: 1.75rem;
      }
      #shareWhatsAppBtn .share-icon {
        width: 1rem;
        height: 1rem;
      }
      .modal-header {
        gap: 0.5rem;
        padding-bottom: 0.75rem;
        margin-bottom: 0.75rem;
        max-width: 95%;
      }
      .modal-header .logo-placeholder {
        width: 2.25rem;
      }
      .modal-header .spacer {
        width: 2.25rem;
      }
      .modal-details {
        gap: 0.5rem;
        padding: 0.75rem 0;
        max-width: 95%;
      }
      .modal-details p {
        font-size: clamp(0.75rem, 3vw, 0.85rem);
      }
      .modal-details p span:first-child {
        font-size: clamp(0.65rem, 2.5vw, 0.75rem);
      }
      .modal-footer {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        max-width: 95%;
      }
      .modal-footer p {
        font-size: clamp(0.65rem, 2.5vw, 0.75rem);
      }
    }
    @media (max-width: 480px) {
      .modal-content {
        min-width: 90%;
        padding: 0.75rem;
      }
      .modal-close {
        top: 0.5rem;
        right: 0.5rem;
        font-size: 0.875rem;
      }
      #shareWhatsAppBtn {
        right: 2rem;
        width: 1.5rem;
        height: 1.5rem;
      }
      #shareWhatsAppBtn .share-icon {
        width: 0.875rem;
        height: 0.875rem;
      }
      .modal-header {
        max-width: 95%;
      }
      .modal-header .logo-placeholder {
        width: 2rem;
      }
      .modal-header .spacer {
        width: 2rem;
      }
      .modal-header h2 {
        font-size: clamp(1.125rem, 4vw, 1.25rem);
      }
      .modal-header p {
        font-size: clamp(0.65rem, 2.5vw, 0.75rem);
      }
      .modal-details {
        max-width: 95%;
      }
      .modal-details p {
        font-size: clamp(0.7rem, 2.8vw, 0.8rem);
      }
      .modal-details p span:first-child {
        font-size: clamp(0.6rem, 2.3vw, 0.7rem);
      }
      .modal-footer {
        max-width: 95%;
      }
    }

    header {
      background-color: var(--primary-color);
      color: white;
      box-shadow: var(--shadow-md);
      position: sticky;
      top: 0;
      z-index: 20;
    }
    header .max-w-7xl {
      max-width: 80rem;
      margin-left: auto;
      margin-right: auto;
      padding: 1.25rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header .flex {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    header img {
      height: 3rem;
      width: auto;
    }
    header a {
      color: white;
      text-decoration: none;
      transition: color 0.2s;
    }
    header a:hover {
      color: #E5E7EB;
    }
    header h1 {
      font-size: clamp(1.5rem, 5vw, 1.75rem);
      font-weight: 600;
      line-height: 1.2;
    }
    .icon-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 0.5rem;
      transition: background-color 0.2s, transform 0.2s;
      cursor: pointer;
    }
    .icon-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
      transform: scale(1.1);
    }
    .icon-btn svg {
      width: 1.5rem;
      height: 1.5rem;
      fill: none;
      stroke: white;
      stroke-width: 2;
    }

    main {
      max-width: 80rem;
      margin-left: auto;
      margin-right: auto;
      padding: 2.5rem 1.5rem;
    }
    .stats-card {
      background: var(--card-bg);
      border: 1px solid var(--accent-color);
      border-radius: 0.75rem;
      padding: 1.25rem;
      box-shadow: var(--shadow-sm);
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .stats-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }
    .stats-card .value {
      font-size: clamp(1.5rem, 5vw, 1.75rem);
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    .stats-card .label {
      font-size: clamp(0.85rem, 3.2vw, 1rem);
      font-weight: 500;
      color: #6B7280;
    }
    @media (max-width: 768px) {
      .stats-card {
        padding: 1rem;
      }
      .stats-card .value {
        font-size: clamp(1.25rem, 4.5vw, 1.5rem);
      }
      .stats-card .label {
        font-size: clamp(0.75rem, 3vw, 0.875rem);
      }
    }
    @media (max-width: 480px) {
      .stats-card {
        padding: 0.75rem;
      }
      .stats-card .value {
        font-size: clamp(1rem, 4vw, 1.25rem);
      }
      .stats-card .label {
        font-size: clamp(0.7rem, 2.8vw, 0.8rem);
      }
    }

    .grid-cols-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1.25rem;
    }
    @media (min-width: 768px) {
      .md\:grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (min-width: 1024px) {
      .lg\:grid-cols-4 {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }
    .mb-8 {
      margin-bottom: 2.5rem;
    }
    .grid-cols-1 {
      display: grid;
      grid-template-columns: 1fr;
    }
    @media (min-width: 1024px) {
      .lg\:grid-cols-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
      .lg\:col-span-1 {
        grid-column: span 1 / span 1;
      }
      .lg\:col-span-2 {
        grid-column: span 2 / span 2;
      }
    }
    .gap-8 {
      gap: 2.5rem;
    }
    .rounded-xl {
      border-radius: 0.75rem;
    }
    .shadow-md {
      box-shadow: var(--shadow-md);
    }
    .p-6 {
      padding: 1.75rem;
    }
    .text-xl {
      font-size: clamp(1.25rem, 4.5vw, 1.5rem);
      line-height: 1.75rem;
    }
    .font-semibold {
      font-weight: 600;
    }
    .text-gray-800 {
      color: var(--text-color);
    }
    .mb-6 {
      margin-bottom: 1.75rem;
    }
    .space-y-5 > :not([hidden]) ~ :not([hidden]) {
      margin-top: 1.5rem;
    }
    .block {
      display: block;
    }
    .text-sm {
      font-size: clamp(0.85rem, 3.2vw, 0.95rem);
      line-height: 1.4;
    }
    .font-medium {
      font-weight: 500;
    }
    .text-gray-700 {
      color: #4B5563;
    }
    .mt-1 {
      margin-top: 0.5rem;
    }
    .w-full {
      width: 100%;
    }
    .px-4 {
      padding-left: 1rem;
      padding-right: 1rem;
    }
    .py-3 {
      padding-top: 0.75rem;
      padding-bottom: 0.75rem;
    }
    .border {
      border-width: 1px;
    }
    .border-gray-300 {
      border-color: #D1D5DB;
    }
    .rounded-lg {
      border-radius: 0.5rem;
    }
    .focus\:outline-none:focus {
      outline: none;
    }
    .focus\:ring-2:focus {
      --tw-ring-offset-width: 2px;
      box-shadow: 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color), 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--accent-color);
    }
    .transition {
      transition-property: all;
      transition-duration: 200ms;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }
    .grid-cols-1 {
      display: grid;
      grid-template-columns: 1fr;
    }
    @media (min-width: 640px) {
      .sm\:grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    .gap-4 {
      gap: 1rem;
    }
    .flex {
      display: flex;
    }
    .gap-4 {
      gap: 1rem;
    }
    .w-full {
      width: 100%;
    }
    @media (min-width: 640px) {
      .sm\:w-auto {
        width: auto;
      }
    }
    .px-6 {
      padding-left: 1.5rem;
      padding-right: 1.5rem;
    }
    .py-3 {
      padding-top: 0.75rem;
      padding-bottom: 0.75rem;
    }
    .bg-gray-200 {
      background-color: #E5E7EB;
    }
    .text-gray-800 {
      color: var(--text-color);
    }
    .hover\:bg-gray-300:hover {
      background-color: #D1D5DB;
    }
    .text-xs {
      font-size: clamp(0.7rem, 2.8vw, 0.8rem);
      line-height: 1.2;
    }
    .text-gray-500 {
      color: #6B7280;
    }
    .mb-6 {
      margin-bottom: 1.75rem;
    }
    .flex-col {
      flex-direction: column;
    }
    @media (min-width: 640px) {
      .sm\:flex-row {
        flex-direction: row;
      }
    }
    .items-center {
      align-items: center;
    }
    .justify-between {
      justify-content: space-between;
    }
    .flex-wrap {
      flex-wrap: wrap;
    }
    .w-full {
      width: 100%;
    }
    @media (min-width: 640px) {
      .sm\:w-64 {
        width: 16rem;
      }
    }
    .py-2 {
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
    }
    .bg-white {
      background-color: var(--card-bg);
    }
    .text-gray-900 {
      color: var(--text-color);
    }
    .gap-3 {
      gap: 0.75rem;
    }
    .overflow-x-auto {
      overflow-x: auto;
    }
    .border-gray-200 {
      border-color: #E5E7EB;
    }
    .table-auto {
      table-layout: auto;
    }
    .text-sm {
      font-size: clamp(0.85rem, 3.2vw, 0.95rem);
      line-height: 1.4;
    }
    .text-gray-600 {
      color: #4B5563;
    }
    .py-4 {
      padding-top: 1.25rem;
      padding-bottom: 1.25rem;
    }
    .px-4 {
      padding-left: 1rem;
      padding-right: 1rem;
    }
    .text-left {
      text-align: left;
    }
    .font-medium {
      font-weight: 500;
    }
    .hidden {
      display: none;
    }
    .py-8 {
      padding-top: 2.5rem;
      padding-bottom: 2.5rem;
    }
    .text-gray-500 {
      color: #6B7280;
    }
    .border-t {
      border-top-width: 1px;
    }
    .hover\:bg-gray-50:hover {
      background-color: #F9FAFB;
    }
    .px-3 {
      padding-left: 0.75rem;
      padding-right: 0.75rem;
    }
    .py-1 {
      padding-top: 0.25rem;
      padding-bottom: 0.25rem;
    }
    .rounded-full {
      border-radius: 9999px;
    }
    .h-5 {
      height: 1.25rem;
    }
    .w-5 {
      width: 1.25rem;
    }
    input::placeholder,
    select::placeholder {
      color: #9CA3AF;
      opacity: 0.8;
    }
    input:focus,
    select:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(209, 163, 63, 0.2);
    }
    button {
      transition: background-color 0.2s, transform 0.2s;
    }
    button:hover {
      transform: translateY(-1px);
    }

    .tabs button {
      border-bottom: 2px solid transparent;
    }
    .tabs button.active {
      background-color: var(--primary-color);
      color: white;
      border-bottom-color: var(--accent-color);
    }
    .tabs button:not(.active) {
      background-color: #E5E7EB;
      color: var(--text-color);
    }
  </style>
</head>
<body>
  <header class="bg-[var(--primary-color)] text-white shadow-lg sticky top-0 z-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="logo2.png" alt="Jain Logo" class="h-10 w-auto">
        <a href="index.html" class="text-white hover:text-gray-300"><h1 class="text-2xl font-semibold">श्री शांतिनाथ दिगम्बर जैन मंदिर</h1></a>
      </div>
      <nav id="headerNav"></nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl font-bold text-[var(--text-color)] mb-6 text-center">Temple Financial Management</h1>

    <div class="tabs mb-6 flex gap-2">
      <button id="donationsTab" class="px-6 py-2 rounded-t-lg active">Donations</button>
      <button id="expensesTab" class="px-6 py-2 rounded-t-lg">Expenses</button>
    </div>

    <div id="donationsContent">
      <div class="mb-8 grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="stats-card">
          <div class="value" id="donTotalCount">0</div>
          <div class="label">Total Donation Records</div>
        </div>
        <div class="stats-card">
          <div class="value" id="donPendingCount">0</div>
          <div class="label">Pending Donations</div>
        </div>
        <div class="stats-card">
          <div class="value" id="donCompletedCount">0</div>
          <div class="label">Completed Donations</div>
        </div>
        <div class="stats-card">
          <div class="value" id="donTotalAmountDisplay">₹0.00</div>
          <div class="label">Total Pledged Donations</div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <section class="bg-[var(--card-bg)] rounded-xl shadow-md p-6 lg:col-span-1">
          <h2 class="text-xl font-semibold text-[var(--text-color)] mb-6">Add / Edit Donation</h2>
          <form id="donationForm" class="space-y-5">
            <input type="hidden" id="donEditingId" />
            <div>
              <label for="donDonor" class="block text-sm font-medium text-[var(--text-color)]">Donor Name</label>
              <input id="donDonor" placeholder="e.g., Your name" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition" />
              <p id="donDonorError" class="error-text hidden">Please enter a valid donor name.</p>
            </div>
            <div>
              <label for="donEventName" class="block text-sm font-medium text-[var(--text-color)]">Event Name</label>
              <input id="donEventName" placeholder="e.g., Event name" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition" />
              <p id="donEventNameError" class="error-text hidden">Please enter a valid event name.</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label for="donEventDate" class="block text-sm font-medium text-[var(--text-color)]">Event Date</label>
                <input id="donEventDate" type="date" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition" />
                <p id="donEventDateError" class="error-text hidden">Please select a valid event date.</p>
              </div>
              <div>
                <label for="donTotalAmount" class="block text-sm font-medium text-[var(--text-color)]">Total Amount (INR)</label>
                <input id="donTotalAmount" type="number" min="0" step="0.01" placeholder="e.g., 500.00" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition" />
                <p id="donTotalAmountError" class="error-text hidden">Please enter a valid total amount (≥ 0).</p>
              </div>
            </div>
            <div>
              <label for="donPaidAmount" class="block text-sm font-medium text-[var(--text-color)]">Paid Amount (INR)</label>
              <input id="donPaidAmount" type="number" min="0" step="0.01" placeholder="e.g., 100.00" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition" />
              <p id="donPaidAmountError" class="error-text hidden">Please enter a valid paid amount (≥ 0 and ≤ total amount).</p>
            </div>
            <div>
              <label for="donContact" class="block text-sm font-medium text-[var(--text-color)]">Contact Number</label>
              <input id="donContact" placeholder="e.g., 9876543210" type="tel" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition" />
            </div>
            <div>
              <label for="donReceiptId" class="block text-sm font-medium text-[var(--text-color)]">Receipt ID</label>
              <input id="donReceiptId" placeholder="e.g., 12345" type="text" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition" />
            </div>
            <div>
              <label for="donPaymentMode" class="block text-sm font-medium text-[var(--text-color)]">Payment Mode</label>
              <select id="donPaymentMode" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition">
                <option value="cash">Cash</option>
                <option value="online">Online</option>
                <option value="cheque">Cheque</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="flex gap-4">
              <button type="submit" id="donSaveBtn" class="w-full sm:w-auto px-6 py-3 bg-[var(--primary-color)] text-white rounded-lg hover:bg-[#5A204A] transition">Save Donation</button>
              <button type="button" id="donResetBtn" class="w-full sm:w-auto px-6 py-3 bg-gray-200 text-[var(--text-color)] rounded-lg hover:bg-gray-300 transition">Reset</button>
            </div>
            <p class="text-xs text-gray-500">Data is managed by the backend server.</p>
          </form>
        </section>

        <section class="bg-[var(--card-bg)] rounded-xl shadow-md p-6 lg:col-span-2">
          <h2 class="text-xl font-semibold text-[var(--text-color)] mb-6">Donations</h2>
          <div class="mb-6 flex flex-col sm:flex-row gap-4 items-center justify-between flex-wrap">
            <div class="flex flex-col sm:flex-row gap-3 items-center w-full sm:w-auto">
              <input id="donSearch" type="search" placeholder="Search donor or event..." class="w-full sm:w-64 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] bg-white text-[var(--text-color)] transition" />
              <select id="donFilterStatus" class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] bg-white text-[var(--text-color)]">
                <option value="all">All Statuses</option>
                <option value="completed">Completed</option>
                <option value="pending">Pending</option>
              </select>
            </div>
            <div class="flex gap-3 flex-wrap">
              <button id="donSelectAll" class="w-full sm:w-auto px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">Select All</button>
              <button id="donDeselectAll" class="w-full sm:w-auto px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">Deselect All</button>
              <button id="donExportCsv" class="w-full sm:w-auto px-4 py-2 bg-[var(--primary-color)] text-white rounded-lg hover:bg-[#5A204A] transition">Export Selected CSV</button>
              <button id="donBackupBtn" class="w-full sm:w-auto px-4 py-2 bg-[var(--accent-color)] text-[var(--primary-color)] rounded-lg hover:bg-[#F0E68C] transition">Backup</button>
            </div>
          </div>
          <div class="overflow-x-auto border border-gray-200 rounded-lg">
            <table class="w-full table-auto">
              <thead>
                <tr class="text-sm text-gray-600 bg-gray-50">
                  <th class="py-4 px-4 text-left font-medium">
                    <input type="checkbox" id="donSelectAllCheckbox" class="w-4 h-4 text-[var(--primary-color)] bg-white border-gray-300 rounded focus:ring-[var(--accent-color)] focus:ring-2">
                  </th>
                  <th class="py-4 px-4 text-left font-medium">Donor</th>
                  <th class="py-4 px-4 text-left font-medium">Event</th>
                  <th class="py-4 px-4 text-left font-medium">Date</th>
                  <th class="py-4 px-4 text-left font-medium">Amount</th>
                  <th class="py-4 px-4 text-left font-medium">Status</th>
                  <th class="py-4 px-4 text-left font-medium">Actions</th>
                </tr>
              </thead>
              <tbody id="donTbody"></tbody>
            </table>
            <div id="donEmpty" class="hidden text-center py-8 text-gray-500 bg-white">No donations yet. Add the first one.</div>
          </div>
        </section>
      </div>
    </div>

    <div id="expensesContent" class="hidden">
      <div class="mb-8 grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="stats-card">
          <div class="value" id="expTotalCount">0</div>
          <div class="label">Total Expense Records</div>
        </div>
        <div class="stats-card">
          <div class="value" id="expPendingCount">0</div>
          <div class="label">Pending Expenses</div>
        </div>
        <div class="stats-card">
          <div class="value" id="expCompletedCount">0</div>
          <div class="label">Completed Expenses</div>
        </div>
        <div class="stats-card">
          <div class="value" id="expTotalAmountDisplay">₹0.00</div>
          <div class="label">Total Committed Expenses</div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <section class="bg-[var(--card-bg)] rounded-xl shadow-md p-6 lg:col-span-1">
          <h2 class="text-xl font-semibold text-[var(--text-color)] mb-6">Add / Edit Expense</h2>
          <form id="expenseForm" class="space-y-5">
            <input type="hidden" id="expEditingId" />
            <div>
              <label for="expRecipient" class="block text-sm font-medium text-[var(--text-color)]">Recipient/Vendor Name</label>
              <input id="expRecipient" placeholder="e.g., Vendor name" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition" />
              <p id="expRecipientError" class="error-text hidden">Please enter a valid recipient name.</p>
            </div>
            <div>
              <label for="expPurpose" class="block text-sm font-medium text-[var(--text-color)]">Purpose</label>
              <input id="expPurpose" placeholder="e.g., Tents, Flowers" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition" />
              <p id="expPurposeError" class="error-text hidden">Please enter a valid purpose.</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label for="expDate" class="block text-sm font-medium text-[var(--text-color)]">Date</label>
                <input id="expDate" type="date" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition" />
                <p id="expDateError" class="error-text hidden">Please select a valid date.</p>
              </div>
              <div>
                <label for="expTotalAmount" class="block text-sm font-medium text-[var(--text-color)]">Total Amount (INR)</label>
                <input id="expTotalAmount" type="number" min="0" step="0.01" placeholder="e.g., 500.00" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition" />
                <p id="expTotalAmountError" class="error-text hidden">Please enter a valid total amount (≥ 0).</p>
              </div>
            </div>
            <div>
              <label for="expPaidAmount" class="block text-sm font-medium text-[var(--text-color)]">Paid Amount (INR)</label>
              <input id="expPaidAmount" type="number" min="0" step="0.01" placeholder="e.g., 100.00" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition" />
              <p id="expPaidAmountError" class="error-text hidden">Please enter a valid paid amount (≥ 0 and ≤ total amount).</p>
            </div>
            <div>
              <label for="expContact" class="block text-sm font-medium text-[var(--text-color)]">Contact Number</label>
              <input id="expContact" placeholder="e.g., 9876543210" type="tel" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition" />
              <p id="expContactError" class="error-text hidden"></p>
            </div>
            <div>
              <label for="expReceiptId" class="block text-sm font-medium text-[var(--text-color)]">Receipt ID</label>
              <input id="expReceiptId" placeholder="e.g., 12345" type="text" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition" />
              <p id="expReceiptIdError" class="error-text hidden"></p>
            </div>
            <div>
              <label for="expPaymentMode" class="block text-sm font-medium text-[var(--text-color)]">Payment Mode</label>
              <select id="expPaymentMode" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition">
                <option value="cash">Cash</option>
                <option value="online">Online</option>
                <option value="cheque">Cheque</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="flex gap-4">
              <button type="submit" id="expSaveBtn" class="w-full sm:w-auto px-6 py-3 bg-[var(--primary-color)] text-white rounded-lg hover:bg-[#5A204A] transition">Save Expense</button>
              <button type="button" id="expResetBtn" class="w-full sm:w-auto px-6 py-3 bg-gray-200 text-[var(--text-color)] rounded-lg hover:bg-gray-300 transition">Reset</button>
            </div>
            <p class="text-xs text-gray-500">Data is managed by the backend server.</p>
          </form>
        </section>

        <section class="bg-[var(--card-bg)] rounded-xl shadow-md p-6 lg:col-span-2">
          <h2 class="text-xl font-semibold text-[var(--text-color)] mb-6">Expenses</h2>
          <div class="mb-6 flex flex-col sm:flex-row gap-4 items-center justify-between flex-wrap">
            <div class="flex flex-col sm:flex-row gap-3 items-center w-full sm:w-auto">
              <input id="expSearch" type="search" placeholder="Search recipient or purpose..." class="w-full sm:w-64 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] bg-white text-[var(--text-color)] transition" />
              <select id="expFilterStatus" class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] bg-white text-[var(--text-color)]">
                <option value="all">All Statuses</option>
                <option value="completed">Completed</option>
                <option value="pending">Pending</option>
              </select>
            </div>
            <div class="flex gap-3 flex-wrap">
              <button id="expSelectAll" class="w-full sm:w-auto px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">Select All</button>
              <button id="expDeselectAll" class="w-full sm:w-auto px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">Deselect All</button>
              <button id="expExportCsv" class="w-full sm:w-auto px-4 py-2 bg-[var(--primary-color)] text-white rounded-lg hover:bg-[#5A204A] transition">Export Selected CSV</button>
              <button id="expBackupBtn" class="w-full sm:w-auto px-4 py-2 bg-[var(--accent-color)] text-[var(--primary-color)] rounded-lg hover:bg-[#F0E68C] transition">Backup</button>
            </div>
          </div>
          <div class="overflow-x-auto border border-gray-200 rounded-lg">
            <table class="w-full table-auto">
              <thead>
                <tr class="text-sm text-gray-600 bg-gray-50">
                  <th class="py-4 px-4 text-left font-medium">
                    <input type="checkbox" id="expSelectAllCheckbox" class="w-4 h-4 text-[var(--primary-color)] bg-white border-gray-300 rounded focus:ring-[var(--accent-color)] focus:ring-2">
                  </th>
                  <th class="py-4 px-4 text-left font-medium">Recipient</th>
                  <th class="py-4 px-4 text-left font-medium">Purpose</th>
                  <th class="py-4 px-4 text-left font-medium">Date</th>
                  <th class="py-4 px-4 text-left font-medium">Amount</th>
                  <th class="py-4 px-4 text-left font-medium">Status</th>
                  <th class="py-4 px-4 text-left font-medium">Actions</th>
                </tr>
              </thead>
              <tbody id="expTbody"></tbody>
            </table>
            <div id="expEmpty" class="hidden text-center py-8 text-gray-500 bg-white">No expenses yet. Add the first one.</div>
          </div>
        </section>
      </div>
    </div>
<div id="previewModal" class="modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <button id="shareWhatsAppBtn">
      <img src="share.png" alt="Share Icon" class="share-icon">
    </button>
    <div class="modal-header">
      <img src="logo2.png" alt="Jain Logo" class="logo-placeholder">
      <div class="center-text-wrapper">
        <div class="text-container">
          <h2 id="modalTitle">श्री शांतिनाथ दिगम्बर जैन मंदिर</h2>
          <p id="modalSubtitle">दान रसीद</p>
        </div>
      </div>
      <div class="spacer"></div>
    </div>
    <div class="modal-details">
      <p><span id="modalLabel1">Donor Name</span><span id="modalField1"></span></p>
      <p><span id="modalLabel2">Event Name</span><span id="modalField2"></span></p>
      <p><span>Event Date</span><span id="modalEventDate"></span></p>
      <p><span>Total Amount</span><span id="modalTotalAmount"></span></p>
      <p><span>Paid Amount</span><span id="modalPaidAmount"></span></p>
      <p><span>Pending Amount</span><span id="modalPendingAmount"></span></p>
      <p><span>Status</span><span id="modalStatus"></span></p>
      <p><span>Contact Number</span><span id="modalContact"></span></p>
      <p><span>Receipt ID</span><span id="modalReceiptId"></span></p>
      <p><span>Payment Mode</span><span id="modalPaymentMode"></span></p>
    </div>
    <div class="modal-footer">
      <p id="modalThankYou">Thank you for your support.</p>
      <p>Issued on: <span id="issueDate"></span></p>
    </div>
  </div>
</div>
  </main>

  <footer class="bg-[var(--primary-color)] text-white text-center p-4">
    <p>&copy; 2025 श्री शांतिनाथ दिगम्बर जैन मंदिर. All rights reserved.</p>
  </footer>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    function formatCurrency(n) {
      return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 2 }).format(Number(n) || 0);
    }

    const donationsTab = document.getElementById('donationsTab');
    const expensesTab = document.getElementById('expensesTab');
    const donationsContent = document.getElementById('donationsContent');
    const expensesContent = document.getElementById('expensesContent');

    function switchTab(tab) {
      [donationsTab, expensesTab].forEach(t => t.classList.remove('active'));
      [donationsContent, expensesContent].forEach(c => c.classList.add('hidden'));
      tab.classList.add('active');
      if (tab === donationsTab) donationsContent.classList.remove('hidden');
      if (tab === expensesTab) expensesContent.classList.remove('hidden');
    }

    donationsTab.addEventListener('click', () => switchTab(donationsTab));
    expensesTab.addEventListener('click', () => switchTab(expensesTab));

    // Donations variables
    const donForm = document.getElementById('donationForm');
    const donDonor = document.getElementById('donDonor');
    const donEventName = document.getElementById('donEventName');
    const donEventDate = document.getElementById('donEventDate');
    const donTotalAmount = document.getElementById('donTotalAmount');
    const donPaidAmount = document.getElementById('donPaidAmount');
    const donContact = document.getElementById('donContact');
    const donReceiptId = document.getElementById('donReceiptId');
    const donPaymentMode = document.getElementById('donPaymentMode');
    const donDonorError = document.getElementById('donDonorError');
    const donEventNameError = document.getElementById('donEventNameError');
    const donEventDateError = document.getElementById('donEventDateError');
    const donTotalAmountError = document.getElementById('donTotalAmountError');
    const donPaidAmountError = document.getElementById('donPaidAmountError');
    const donContactError = document.getElementById('donContactError');
    const donReceiptIdError = document.getElementById('donReceiptIdError');
    const donEditingId = document.getElementById('donEditingId');
    const donTbody = document.getElementById('donTbody');
    const donEmpty = document.getElementById('donEmpty');
    const donTotalCount = document.getElementById('donTotalCount');
    const donPendingCount = document.getElementById('donPendingCount');
    const donCompletedCount = document.getElementById('donCompletedCount');
    const donTotalAmountDisplay = document.getElementById('donTotalAmountDisplay');
    const donSearch = document.getElementById('donSearch');
    const donFilterSel = document.getElementById('donFilterStatus');
    const donExportBtn = document.getElementById('donExportCsv');
    const donBackupBtn = document.getElementById('donBackupBtn');
    const donSelectAllBtn = document.getElementById('donSelectAll');
    const donDeselectAllBtn = document.getElementById('donDeselectAll');
    const donSelectAllCheckbox = document.getElementById('donSelectAllCheckbox');

    // Expenses variables
    const expForm = document.getElementById('expenseForm');
    const expRecipient = document.getElementById('expRecipient');
    const expPurpose = document.getElementById('expPurpose');
    const expDate = document.getElementById('expDate');
    const expTotalAmount = document.getElementById('expTotalAmount');
    const expPaidAmount = document.getElementById('expPaidAmount');
    const expContact = document.getElementById('expContact');
    const expReceiptId = document.getElementById('expReceiptId');
    const expPaymentMode = document.getElementById('expPaymentMode');
    const expRecipientError = document.getElementById('expRecipientError');
    const expPurposeError = document.getElementById('expPurposeError');
    const expDateError = document.getElementById('expDateError');
    const expTotalAmountError = document.getElementById('expTotalAmountError');
    const expPaidAmountError = document.getElementById('expPaidAmountError');
    const expContactError = document.getElementById('expContactError');
    const expReceiptIdError = document.getElementById('expReceiptIdError');
    const expEditingId = document.getElementById('expEditingId');
    const expTbody = document.getElementById('expTbody');
    const expEmpty = document.getElementById('expEmpty');
    const expTotalCount = document.getElementById('expTotalCount');
    const expPendingCount = document.getElementById('expPendingCount');
    const expCompletedCount = document.getElementById('expCompletedCount');
    const expTotalAmountDisplay = document.getElementById('expTotalAmountDisplay');
    const expSearch = document.getElementById('expSearch');
    const expFilterSel = document.getElementById('expFilterStatus');
    const expExportBtn = document.getElementById('expExportCsv');
    const expBackupBtn = document.getElementById('expBackupBtn');
    const expSelectAllBtn = document.getElementById('expSelectAll');
    const expDeselectAllBtn = document.getElementById('expDeselectAll');
    const expSelectAllCheckbox = document.getElementById('expSelectAllCheckbox');

    // Shared modal
    const previewModal = document.getElementById('previewModal');
    const modalClose = document.querySelector('.modal-close');
    const modalTitle = document.getElementById('modalTitle');
    const modalSubtitle = document.getElementById('modalSubtitle');
    const modalLabel1 = document.getElementById('modalLabel1');
    const modalLabel2 = document.getElementById('modalLabel2');
    const modalField1 = document.getElementById('modalField1');
    const modalField2 = document.getElementById('modalField2');
    const modalEventDate = document.getElementById('modalEventDate');
    const modalTotalAmount = document.getElementById('modalTotalAmount');
    const modalPaidAmount = document.getElementById('modalPaidAmount');
    const modalPendingAmount = document.getElementById('modalPendingAmount');
    const modalStatus = document.getElementById('modalStatus');
    const modalContact = document.getElementById('modalContact');
    const modalReceiptId = document.getElementById('modalReceiptId');
    const modalPaymentMode = document.getElementById('modalPaymentMode');
    const modalThankYou = document.getElementById('modalThankYou');
    const issueDate = document.getElementById('issueDate');
    const shareWhatsAppBtn = document.getElementById('shareWhatsAppBtn');
    const headerNav = document.getElementById('headerNav');

    let donations = [];
    let expenses = [];
    let donFilterStatus = 'all';
    let donSearchText = '';
    let expFilterStatus = 'all';
    let expSearchText = '';
    let currentItem = null;
    let currentType = null;
    let selectedDonations = new Set();
    let selectedExpenses = new Set();

    donEventDate.valueAsDate = new Date();
    expDate.valueAsDate = new Date();

    const token = localStorage.getItem('token');
    if (token) {
      const logoutA = document.createElement('a');
      logoutA.href = '#';
      logoutA.className = 'icon-btn';
      logoutA.title = 'Logout';
      logoutA.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
          <path d="M17 16l4-4m0 0l-4-4m4 4H7m5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h3a3 3 0 013 3v1" />
        </svg>
      `;
      logoutA.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('token');
        window.location.href = '/login.html';
      });
      headerNav.appendChild(logoutA);
    } else {
      const loginA = document.createElement('a');
      loginA.href = '/login.html';
      loginA.className = 'icon-btn';
      loginA.title = 'Admin Login';
      loginA.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-3.33 0-6 2.67-6 6v1h12v-1c0-3.33-2.67-6-6-6z" />
        </svg>
      `;
      headerNav.appendChild(loginA);
    }

    function openModal(item, type) {
      console.log('Opening modal with item:', item); // Debug log
      currentItem = item;
      currentType = type;
      modalTitle.textContent = 'श्री शांतिनाथ दिगम्बर जैन मंदिर';
      if (type === 'donation') {
        modalSubtitle.textContent = 'दान रसीद';
        modalLabel1.textContent = 'Donor Name';
        modalLabel2.textContent = 'Event Name';
        modalField1.textContent = item.donor || 'N/A';
        modalField2.textContent = item.eventName || 'N/A';
        modalThankYou.textContent = 'Thank you for your support.';
      } else {
        modalSubtitle.textContent = 'व्यय रसीद';
        modalLabel1.textContent = 'Recipient Name';
        modalLabel2.textContent = 'Purpose';
        modalField1.textContent = item.recipient || 'N/A';
        modalField2.textContent = item.purpose || 'N/A';
        modalThankYou.textContent = 'Thank you for your service.';
      }
      modalEventDate.textContent = new Date(item.date || item.eventDate).toISOString().split('T')[0] || 'N/A';
      modalTotalAmount.textContent = formatCurrency(parseFloat(item.totalAmount));
      modalPaidAmount.textContent = formatCurrency(parseFloat(item.paidAmount));
      const pendingAmount = (parseFloat(item.totalAmount) || 0) - (parseFloat(item.paidAmount) || 0);
      modalPendingAmount.textContent = formatCurrency(pendingAmount);
      modalStatus.textContent = item.status ? (item.status.charAt(0).toUpperCase() + item.status.slice(1)) : 'N/A';
      modalContact.textContent = item.contact || 'N/A';
      modalReceiptId.textContent = item.receiptId || 'N/A';
      modalPaymentMode.textContent = item.paymentMode ? (item.paymentMode.charAt(0).toUpperCase() + item.paymentMode.slice(1)) : 'N/A';
      issueDate.textContent = new Date().toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' });
      previewModal.style.display = 'flex';
    }

    modalClose.addEventListener('click', () => {
      previewModal.style.display = 'none';
      currentItem = null;
      currentType = null;
    });

    previewModal.addEventListener('click', (e) => {
      if (e.target === previewModal) {
        previewModal.style.display = 'none';
        currentItem = null;
        currentType = null;
      }
    });

    // shareWhatsAppBtn.addEventListener('click', async () => {
    //   if (!currentItem || !currentType) {
    //     alert('No receipt data available.');
    //     return;
    //   }

    //   try {
    //     const issueDate = new Date().toISOString().split('T')[0];
    //     const data = {
    //       ...currentItem,
    //       issueDate,
    //       type: currentType,
    //       eventDate: currentType === 'donation' ? currentItem.eventDate : undefined,
    //       date: currentType === 'expense' ? currentItem.date : undefined,
    //       pendingAmount: currentItem.totalAmount - currentItem.paidAmount,
    //       contact: currentItem.contact || '',
    //       receiptId: currentItem.receiptId || '',
    //       paymentMode: currentItem.paymentMode || 'cash'
    //     };

    //     console.log('Sending PDF data:', data); // Debug log to verify data sent to backend

    //     const response = await fetch('https://temple-1.onrender.com/api/generate-pdf', {
    //       method: 'POST',
    //       headers: {
    //         'Content-Type': 'application/json',
    //         'Authorization': `Bearer ${localStorage.getItem('token')}`
    //       },
    //       body: JSON.stringify(data)
    //     });

    //     if (!response.ok) {
    //       throw new Error(`Failed to generate PDF: ${response.statusText}`);
    //     }

    //     const blob = await response.blob();
    //     const file = new File([blob], `${currentType}-receipt.pdf`, { type: 'application/pdf' });

    //     if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
    //       await navigator.share({
    //         files: [file],
    //         title: 'Receipt - श्री शांतिनाथ दिगम्बर जैन मंदिर',
    //         text: `Here is your ${currentType} receipt from श्री शांतिनाथ दिगम्बर जैन मंदिर.`
    //       });
    //     } else {
    //       const url = URL.createObjectURL(blob);
    //       const link = document.createElement('a');
    //       link.href = url;
    //       link.download = `${currentType}-receipt.pdf`;
    //       document.body.appendChild(link);
    //       link.click();
    //       document.body.removeChild(link);
    //       URL.revokeObjectURL(url);
    //       const message = encodeURIComponent(`Here is your ${currentType} receipt from श्री शांतिनाथ दिगम्बर जैन मंदिर.`);
    //       const whatsappUrl = `https://wa.me/?text=${message}`;
    //       window.open(whatsappUrl, '_blank');
    //       alert('Receipt downloaded. Please manually attach the PDF in WhatsApp.');
    //     }
    //   } catch (error) {
    //     console.error('Error sharing PDF:', error);
    //     alert('Failed to generate or share receipt: ' + error.message);
    //   }
    // });

    shareWhatsAppBtn.addEventListener('click', async () => {
  if (!currentItem || !currentType) {
    alert('No receipt data available.');
    return;
  }

  try {
    const issueDate = new Date().toISOString().split('T')[0];
    const data = {
      ...currentItem,
      issueDate,
      type: currentType,
      eventDate: currentType === 'donation' ? currentItem.eventDate : undefined,
      date: currentType === 'expense' ? currentItem.date : undefined,
      pendingAmount: currentItem.totalAmount - currentItem.paidAmount,
      contact: currentItem.contact || '',
      receiptId: currentItem.receiptId || '',
      paymentMode: currentItem.paymentMode || 'cash'
    };

    const response = await fetch('https://temple-1.onrender.com/api/generate-pdf', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify(data)
    });

    if (!response.ok) {
      throw new Error(`Failed to generate PDF: ${response.statusText}`);
    }

    const blob = await response.blob();
    const file = new File([blob], 'JainMandirReceipt.pdf', { type: 'application/pdf' });

    const recipientName = currentType === 'donation' ? currentItem.donor : currentItem.recipient;
    const message = `जय जिनेन्द्र 🙏
आदरणीय ${recipientName}
कृपया ${currentType === 'donation' ? 'दान' : 'व्यय'} की रसीद प्राप्त करें,
सादर,
श्री दिगम्बर जैन भगवान शांतिनाथ प्रभावना समिति`;

    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        files: [file],
        title: 'Receipt - श्री शांतिनाथ दिगम्बर जैन मंदिर',
        text: message
      });
    } else {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'JainMandirReceipt.pdf';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
      window.open(whatsappUrl, '_blank');
      alert('Receipt downloaded as JainMandirReceipt.pdf. Please manually attach the PDF in WhatsApp.');
    }
  } catch (error) {
    console.error('Error sharing PDF:', error);
    alert('Failed to generate or share receipt: ' + error.message);
  }
});


    function getAuthHeaders() {
      const token = localStorage.getItem('token');
      return token ? { 'Authorization': `Bearer ${token}` } : {};
    }

    async function fetchDonations() {
      try {

        
        const response = await fetch('https://temple-1.onrender.com/api/donations/admin', {
          headers: getAuthHeaders()
        });
        if (!response.ok) {
          if (response.status === 401 || response.status === 403) {
            alert('Session expired or unauthorized. Please log in again.');
            window.location.href = '/login.html';
            return;
          }
          const errorText = await response.text();
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }
        donations = await response.json();
        console.log('Fetched donations:', donations); // Debug log to verify fetched data
        renderDonations();
      } catch (error) {
        console.error('Error fetching donations:', error);
        alert('Failed to fetch donations: ' + error.message);
      }
    }

    async function fetchExpenses() {
      try {
        const response = await fetch('https://temple-1.onrender.com/api/expenses/admin', {
          headers: getAuthHeaders()
        });
        if (!response.ok) {
          if (response.status === 401 || response.status === 403) {
            alert('Session expired or unauthorized. Please log in again.');
            window.location.href = '/login.html';
            return;
          }
          const errorText = await response.text();
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }
        expenses = await response.json();
        console.log('Fetched expenses:', expenses); // Debug log to verify fetched data
        renderExpenses();
      } catch (error) {
        console.error('Error fetching expenses:', error);
        alert('Failed to fetch expenses: ' + error.message);
      }
    }

    function renderDonations() {
      const q = donSearchText.trim().toLowerCase();
      const view = donations.filter(d => {
        const okStatus = donFilterStatus === 'all' ? true : d.status === donFilterStatus;
        const okSearch = !q ? true : (d.donor.toLowerCase().includes(q) || (d.eventName || '').toLowerCase().includes(q));
        return okStatus && okSearch;
      });

      donTotalCount.textContent = donations.length;
      donPendingCount.textContent = donations.filter(d => d.status === 'pending').length;
      donCompletedCount.textContent = donations.filter(d => d.status === 'completed').length;
      donTotalAmountDisplay.textContent = formatCurrency(donations.reduce((s, d) => s + Number(d.totalAmount || 0), 0));

      donTbody.innerHTML = '';
      if (view.length === 0) {
        donEmpty.classList.remove('hidden');
        updateDonationSelectAllCheckbox();
        return;
      }
      donEmpty.classList.add('hidden');
      for (const d of view) {
        const tr = document.createElement('tr');
        tr.className = 'border-t border-gray-200 hover:bg-gray-50 transition';
        tr.innerHTML = `
          <td class="py-4 px-4">
            <input type="checkbox" class="donation-checkbox w-4 h-4 text-[var(--primary-color)] bg-white border-gray-300 rounded focus:ring-[var(--accent-color)] focus:ring-2" data-id="${d._id}" ${selectedDonations.has(d._id) ? 'checked' : ''}>
          </td>
          <td class="py-4 px-4 font-medium">${escapeHtml(d.donor)}</td>
          <td class="py-4 px-4">${escapeHtml(d.eventName || 'None')}</td>
          <td class="py-4 px-4">${escapeHtml(new Date(d.eventDate).toISOString().split('T')[0])}</td>
          <td class="py-4 px-4">${formatCurrency(Number(d.totalAmount))}</td>
          <td class="py-4 px-4">
            <span class="inline-block px-3 py-1 text-xs font-medium rounded-full ${d.status === 'completed' ? 'bg-[var(--accent-color)] text-[var(--primary-color)]' : 'bg-[#F0E68C] text-[var(--primary-color)]'}">
              ${d.status.charAt(0).toUpperCase() + d.status.slice(1)}
            </span>
          </td>
          <td class="py-4 px-4 flex gap-2">
            <button class="px-4 py-1 bg-[var(--accent-color)] text-[var(--primary-color)] rounded-lg hover:bg-[#F0E68C] transition" data-edit="${d._id}" data-type="donation">Edit</button>
            <button class="px-2 py-1 text-[var(--primary-color)] rounded-lg hover:text-[#5A204A] transition" data-preview="${d._id}" data-type="donation">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
            </button>
          </td>
        `;
        donTbody.appendChild(tr);
      }
      updateDonationSelectAllCheckbox();
    }

    function renderExpenses() {
      const q = expSearchText.trim().toLowerCase();
      const view = expenses.filter(e => {
        const okStatus = expFilterStatus === 'all' ? true : e.status === expFilterStatus;
        const okSearch = !q ? true : (e.recipient.toLowerCase().includes(q) || (e.purpose || '').toLowerCase().includes(q));
        return okStatus && okSearch;
      });

      expTotalCount.textContent = expenses.length;
      expPendingCount.textContent = expenses.filter(e => e.status === 'pending').length;
      expCompletedCount.textContent = expenses.filter(e => e.status === 'completed').length;
      expTotalAmountDisplay.textContent = formatCurrency(expenses.reduce((s, e) => s + Number(e.totalAmount || 0), 0));

      expTbody.innerHTML = '';
      if (view.length === 0) {
        expEmpty.classList.remove('hidden');
        updateExpenseSelectAllCheckbox();
        return;
      }
      expEmpty.classList.add('hidden');
      for (const e of view) {
        const tr = document.createElement('tr');
        tr.className = 'border-t border-gray-200 hover:bg-gray-50 transition';
        tr.innerHTML = `
          <td class="py-4 px-4">
            <input type="checkbox" class="expense-checkbox w-4 h-4 text-[var(--primary-color)] bg-white border-gray-300 rounded focus:ring-[var(--accent-color)] focus:ring-2" data-id="${e._id}" ${selectedExpenses.has(e._id) ? 'checked' : ''}>
          </td>
          <td class="py-4 px-4 font-medium">${escapeHtml(e.recipient)}</td>
          <td class="py-4 px-4">${escapeHtml(e.purpose || 'None')}</td>
          <td class="py-4 px-4">${escapeHtml(new Date(e.date).toISOString().split('T')[0])}</td>
          <td class="py-4 px-4">${formatCurrency(Number(e.totalAmount))}</td>
          <td class="py-4 px-4">
            <span class="inline-block px-3 py-1 text-xs font-medium rounded-full ${e.status === 'completed' ? 'bg-[var(--accent-color)] text-[var(--primary-color)]' : 'bg-[#F0E68C] text-[var(--primary-color)]'}">
              ${e.status.charAt(0).toUpperCase() + e.status.slice(1)}
            </span>
          </td>
          <td class="py-4 px-4 flex gap-2">
            <button class="px-4 py-1 bg-[var(--accent-color)] text-[var(--primary-color)] rounded-lg hover:bg-[#F0E68C] transition" data-edit="${e._id}" data-type="expense">Edit</button>
            <button class="px-2 py-1 text-[var(--primary-color)] rounded-lg hover:text-[#5A204A] transition" data-preview="${e._id}" data-type="expense">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
            </button>
          </td>
        `;
        expTbody.appendChild(tr);
      }
      updateExpenseSelectAllCheckbox();
    }

    function escapeHtml(s) {
      return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
    }

    // Donations logic
function donClearErrors() {
  const errorFields = [
    'donDonorError',
    'donEventNameError',
    'donEventDateError',
    'donTotalAmountError',
    'donPaidAmountError',
    'donStatusError',
    'donContactError',
    'donReceiptIdError',
    'donPaymentModeError'
  ];
  errorFields.forEach(field => {
    const element = document.getElementById(field);
    if (element) {
      element.textContent = ''; // Only set textContent if element exists
    } else {
      console.warn(`Error element not found: ${field}`); // Debug log for missing elements
    }
  });
}

    donTotalAmount.addEventListener('input', () => {
      const value = donTotalAmount.value;
      donTotalAmountError.textContent = !value ? 'Total amount is required.' : Number(value) < 0 ? 'Total amount must be ≥ 0.' : '';
      donTotalAmountError.classList.toggle('hidden', !donTotalAmountError.textContent);
      donValidatePaidAmount();
    });

    donPaidAmount.addEventListener('input', donValidatePaidAmount);

    function donValidatePaidAmount() {
      const total = Number(donTotalAmount.value);
      const paid = Number(donPaidAmount.value);
      donPaidAmountError.textContent = !donPaidAmount.value ? 'Paid amount is required.' : paid < 0 ? 'Paid amount must be ≥ 0.' : isFinite(total) && paid > total ? 'Paid amount cannot exceed total amount.' : '';
      donPaidAmountError.classList.toggle('hidden', !donPaidAmountError.textContent);
    }

    donForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      donClearErrors();

      const data = {
        donor: donDonor.value ? donDonor.value.trim() : '',
        eventName: donEventName.value ? donEventName.value.trim() : '',
        eventDate: donEventDate.value,
        totalAmount: Number(donTotalAmount.value),
        paidAmount: Number(donPaidAmount.value),
        contact: donContact.value ? donContact.value.trim() : '',
        receiptId: donReceiptId.value ? donReceiptId.value.trim() : '',
        paymentMode: donPaymentMode.value
      };

      let hasError = false;
      if (!data.donor) {
        donDonorError.textContent = 'Donor name is required.';
        donDonorError.classList.remove('hidden');
        hasError = true;
      }
      if (!data.eventName) {
        donEventNameError.textContent = 'Event name is required.';
        donEventNameError.classList.remove('hidden');
        hasError = true;
      }
      if (!data.eventDate || isNaN(new Date(data.eventDate).getTime())) {
        donEventDateError.textContent = 'Valid event date is required.';
        donEventDateError.classList.remove('hidden');
        hasError = true;
      }
      if (!donTotalAmount.value || isNaN(data.totalAmount) || data.totalAmount < 0) {
        donTotalAmountError.textContent = !donTotalAmount.value ? 'Total amount is required.' : 'Total amount must be ≥ 0.';
        donTotalAmountError.classList.remove('hidden');
        hasError = true;
      }
      if (!donPaidAmount.value || isNaN(data.paidAmount) || data.paidAmount < 0) {
        donPaidAmountError.textContent = !donPaidAmount.value ? 'Paid amount is required.' : 'Paid amount must be ≥ 0.';
        donPaidAmountError.classList.remove('hidden');
        hasError = true;
      }
      if (isFinite(data.totalAmount) && isFinite(data.paidAmount) && data.paidAmount > data.totalAmount) {
        donPaidAmountError.textContent = 'Paid amount cannot exceed total amount.';
        donPaidAmountError.classList.remove('hidden');
        hasError = true;
      }
      // Optional validation for contact
      if (data.contact && !/^\+?\d{10,15}$/.test(data.contact)) {
        donContactError.textContent = 'Invalid contact number (10-15 digits).';
        donContactError.classList.remove('hidden');
        hasError = true;
      }
      // Optional validation for receiptId
      if (data.receiptId && !/^[a-zA-Z0-9-]+$/.test(data.receiptId)) {
        donReceiptIdError.textContent = 'Invalid receipt ID (alphanumeric and hyphens only).';
        donReceiptIdError.classList.remove('hidden');
        hasError = true;
      }

      if (hasError) {
        alert('Please fix the errors in the form.');
        return;
      }

      console.log('Submitting donation data:', data); // Debug log to verify data before sending

      const id = donEditingId.value;
      try {
        const url = id ? `https://temple-1.onrender.com/api/donations/${id}` : 'https://temple-1.onrender.com/api/donations';
        const method = id ? 'PUT' : 'POST';
        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
          body: JSON.stringify(data)
        });
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }
        const savedData = await response.json();
        console.log('Saved donation:', savedData); // Debug log to verify saved data
        donResetForm();
        fetchDonations();
        alert('Donation saved successfully.');
      } catch (error) {
        console.error('Error saving donation:', error);
        alert('Failed to save donation: ' + error.message);
      }
    });

    function donResetForm() {
      donForm.reset();
      donEditingId.value = '';
      donEventDate.valueAsDate = new Date();
      donClearErrors();
    }
    document.getElementById('donResetBtn').addEventListener('click', donResetForm);

    donTbody.addEventListener('click', (e) => {
      const t = e.target.closest('button');
      if (!t) return;
      const id = t.dataset.edit || t.dataset.preview;
      const d = donations.find(x => x._id === id);
      if (!d) return;
      if (t.dataset.edit) {
        donEditingId.value = d._id;
        donDonor.value = d.donor;
        donEventName.value = d.eventName;
        donEventDate.value = new Date(d.eventDate).toISOString().split('T')[0];
        donTotalAmount.value = d.totalAmount;
        donPaidAmount.value = d.paidAmount;
        donContact.value = d.contact || '';
        donReceiptId.value = d.receiptId || '';
        donPaymentMode.value = d.paymentMode || 'cash';
        donClearErrors();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      if (t.dataset.preview) {
        openModal(d, 'donation');
      }
    });

    donSearch.addEventListener('input', () => {
      donSearchText = donSearch.value;
      renderDonations();
      updateDonationSelectAllCheckbox();
    });

    donFilterSel.addEventListener('change', () => {
      donFilterStatus = donFilterSel.value;
      renderDonations();
      updateDonationSelectAllCheckbox();
    });

    donExportBtn.addEventListener('click', () => {
      const selectedData = selectedDonations.size > 0 
        ? donations.filter(d => selectedDonations.has(d._id))
        : donations;
      
      if (!selectedData.length) {
        alert('No data to export');
        return;
      }
      
      const csv = toCsv(selectedData, 'donation');
      const filename = selectedDonations.size > 0 
        ? `temple-donations-selected-${selectedDonations.size}.csv`
        : 'temple-donations.csv';
      download(filename, csv, 'text/csv;charset=utf-8');
    });

    donBackupBtn.addEventListener('click', async () => {
      if (!donations.length) {
        alert('No data to backup');
        return;
      }
      try {
        const data = generateXLSX(donations);
        const blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const file = new File([blob], 'temple-donations.xlsx', { type: blob.type });
        await backupFile(file, 'Donations Backup');
      } catch (error) {
        console.error('Error creating backup:', error);
        alert('Failed to create backup: ' + error.message);
      }
    });

    // Expenses logic
    function expClearErrors() {
      ['expRecipientError', 'expPurposeError', 'expDateError', 'expTotalAmountError', 'expPaidAmountError', 'expContactError', 'expReceiptIdError'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.textContent = '';
          el.classList.add('hidden');
        }
      });
    }

    expTotalAmount.addEventListener('input', () => {
      const value = expTotalAmount.value;
      expTotalAmountError.textContent = !value ? 'Total amount is required.' : Number(value) < 0 ? 'Total amount must be ≥ 0.' : '';
      expTotalAmountError.classList.toggle('hidden', !expTotalAmountError.textContent);
      expValidatePaidAmount();
    });

    expPaidAmount.addEventListener('input', expValidatePaidAmount);

    function expValidatePaidAmount() {
      const total = Number(expTotalAmount.value);
      const paid = Number(expPaidAmount.value);
      expPaidAmountError.textContent = !expPaidAmount.value ? 'Paid amount is required.' : paid < 0 ? 'Paid amount must be ≥ 0.' : isFinite(total) && paid > total ? 'Paid amount cannot exceed total amount.' : '';
      expPaidAmountError.classList.toggle('hidden', !expPaidAmountError.textContent);
    }

    expForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      expClearErrors();

      const data = {
        recipient: expRecipient.value ? expRecipient.value.trim() : '',
        purpose: expPurpose.value ? expPurpose.value.trim() : '',
        date: expDate.value,
        totalAmount: parseFloat(expTotalAmount.value),
        paidAmount: parseFloat(expPaidAmount.value),
        contact: expContact.value ? expContact.value.trim() : '',
        receiptId: expReceiptId.value ? expReceiptId.value.trim() : '',
        paymentMode: expPaymentMode.value
      };

      let hasError = false;
      if (!data.recipient) {
        expRecipientError.textContent = 'Recipient name is required.';
        expRecipientError.classList.remove('hidden');
        hasError = true;
      }
      if (!data.purpose) {
        expPurposeError.textContent = 'Purpose is required.';
        expPurposeError.classList.remove('hidden');
        hasError = true;
      }
      if (!data.date || isNaN(new Date(data.date).getTime())) {
        expDateError.textContent = 'Valid date is required.';
        expDateError.classList.remove('hidden');
        hasError = true;
      }
      if (!expTotalAmount.value || isNaN(data.totalAmount) || data.totalAmount < 0) {
        expTotalAmountError.textContent = !expTotalAmount.value ? 'Total amount is required.' : 'Total amount must be ≥ 0.';
        expTotalAmountError.classList.remove('hidden');
        hasError = true;
      }
      if (!expPaidAmount.value || isNaN(data.paidAmount) || data.paidAmount < 0) {
        expPaidAmountError.textContent = !expPaidAmount.value ? 'Paid amount is required.' : 'Paid amount must be ≥ 0.';
        expPaidAmountError.classList.remove('hidden');
        hasError = true;
      }
      if (isFinite(data.totalAmount) && isFinite(data.paidAmount) && data.paidAmount > data.totalAmount) {
        expPaidAmountError.textContent = 'Paid amount cannot exceed total amount.';
        expPaidAmountError.classList.remove('hidden');
        hasError = true;
      }
      // Optional validation for contact
      if (data.contact && !/^\+?\d{10,15}$/.test(data.contact)) {
        expContactError.textContent = 'Invalid contact number (10-15 digits).';
        expContactError.classList.remove('hidden');
        hasError = true;
      }
      // Optional validation for receiptId
      if (data.receiptId && !/^[a-zA-Z0-9-]+$/.test(data.receiptId)) {
        expReceiptIdError.textContent = 'Invalid receipt ID (alphanumeric and hyphens only).';
        expReceiptIdError.classList.remove('hidden');
        hasError = true;
      }

      if (hasError) {
        alert('Please fix the errors in the form.');
        return;
      }

      console.log('Submitting expense data:', data); // Debug log to verify data before sending

      const id = expEditingId.value;
      try {
        const url = id ? `https://temple-1.onrender.com/api/expenses/${id}` : 'https://temple-1.onrender.com/api/expenses';
        const method = id ? 'PUT' : 'POST';
        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
          body: JSON.stringify(data)
        });
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }
        const savedData = await response.json();
        console.log('Saved expense:', savedData); // Debug log to verify saved data
        expResetForm();
        fetchExpenses();
        alert('Expense saved successfully.');
      } catch (error) {
        console.error('Error saving expense:', error);
        alert('Failed to save expense: ' + error.message);
      }
    });

    function expResetForm() {
      expForm.reset();
      expEditingId.value = '';
      expDate.valueAsDate = new Date();
      expClearErrors();
    }
    document.getElementById('expResetBtn').addEventListener('click', expResetForm);

    expTbody.addEventListener('click', (e) => {
      const t = e.target.closest('button');
      if (!t) return;
      const id = t.dataset.edit || t.dataset.preview;
      const eItem = expenses.find(x => x._id === id);
      if (!eItem) return;
      console.log('Editing or previewing expense:', eItem); // Debug log
      if (t.dataset.edit) {
        expEditingId.value = eItem._id;
        expRecipient.value = eItem.recipient;
        expPurpose.value = eItem.purpose;
        expDate.value = new Date(eItem.date).toISOString().split('T')[0];
        expTotalAmount.value = eItem.totalAmount;
        expPaidAmount.value = eItem.paidAmount;
        expContact.value = eItem.contact || '';
        expReceiptId.value = eItem.receiptId || '';
        expPaymentMode.value = eItem.paymentMode || 'cash';
        expClearErrors();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      if (t.dataset.preview) {
        openModal(eItem, 'expense');
      }
    });

    expSearch.addEventListener('input', () => {
      expSearchText = expSearch.value;
      renderExpenses();
      updateExpenseSelectAllCheckbox();
    });

    expFilterSel.addEventListener('change', () => {
      expFilterStatus = expFilterSel.value;
      renderExpenses();
      updateExpenseSelectAllCheckbox();
    });

    expExportBtn.addEventListener('click', () => {
      const selectedData = selectedExpenses.size > 0 
        ? expenses.filter(e => selectedExpenses.has(e._id))
        : expenses;
      
      if (!selectedData.length) {
        alert('No data to export');
        return;
      }
      
      const csv = toCsv(selectedData, 'expense');
      const filename = selectedExpenses.size > 0 
        ? `temple-expenses-selected-${selectedExpenses.size}.csv`
        : 'temple-expenses.csv';
      download(filename, csv, 'text/csv;charset=utf-8');
    });

    expBackupBtn.addEventListener('click', async () => {
      if (!expenses.length) {
        alert('No data to backup');
        return;
      }
      try {
        const data = generateXLSX(expenses);
        const blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const file = new File([blob], 'temple-expenses.xlsx', { type: blob.type });
        await backupFile(file, 'Expenses Backup');
      } catch (error) {
        console.error('Error creating backup:', error);
        alert('Failed to create backup: ' + error.message);
      }
    });

    function toCsv(rows, type) {
      if (!rows.length) return '';
      const headers = type === 'donation' ? ['_id', 'donor', 'eventName', 'eventDate', 'totalAmount', 'paidAmount', 'pendingAmount', 'status', 'contact', 'receiptId', 'paymentMode'] : ['_id', 'recipient', 'purpose', 'date', 'totalAmount', 'paidAmount', 'pendingAmount', 'status', 'contact', 'receiptId', 'paymentMode'];
      const esc = v => `"${String(v ?? '').replace(/"/g, '""')}"`;
      const lines = [headers.join(',')];
      for (const r of rows) {
        lines.push(headers.map(h => esc(h === 'eventDate' || h === 'date' ? new Date(r[h]).toISOString().split('T')[0] : r[h])).join(','));
      }
      return lines.join('\n');
    }

    function generateXLSX(rows) {
      if (typeof XLSX === 'undefined') {
        throw new Error('XLSX library is not loaded.');
      }
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Data");
      return XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    }

    function download(filename, content, mime = 'text/plain;charset=utf-8') {
      const blob = new Blob([content], { type: mime });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    }

    async function backupFile(file, title) {
      const subject = encodeURIComponent(`Temple ${title}`);
      const body = encodeURIComponent(`Attached is the backup of ${title.toLowerCase()} data from श्री शांतिनाथ दिगम्बर जैन मंदिर.`);
      const mailtoUrl = `mailto:jainsahil760@gmail.com?subject=${subject}&body=${body}`;

      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          files: [file],
          title: `Temple ${title}`,
          text: `Backup of ${title.toLowerCase()} data. Please email to jainsahil760@gmail.com.`
        });
      } else {
        download(file.name, await file.arrayBuffer(), file.type);
        window.open(mailtoUrl, '_blank');
        alert(`Backup file has been downloaded as ${file.name}. Your email client should have opened with a pre-filled email to jainsahil760@gmail.com. Please manually attach the downloaded file to the email and send it.`);
      }
    }

    fetchDonations();
    fetchExpenses();

    // Donations selection functionality
    donSelectAllBtn.addEventListener('click', () => {
      const visibleDonations = donations.filter(d => {
        const okStatus = donFilterStatus === 'all' ? true : d.status === donFilterStatus;
        const q = donSearchText.trim().toLowerCase();
        const okSearch = !q ? true : (d.donor.toLowerCase().includes(q) || (d.eventName || '').toLowerCase().includes(q));
        return okStatus && okSearch;
      });
      
      visibleDonations.forEach(d => selectedDonations.add(d._id));
      renderDonations();
      updateDonationSelectAllCheckbox();
    });

    donDeselectAllBtn.addEventListener('click', () => {
      selectedDonations.clear();
      renderDonations();
      updateDonationSelectAllCheckbox();
    });

    donSelectAllCheckbox.addEventListener('change', (e) => {
      const visibleDonations = donations.filter(d => {
        const okStatus = donFilterStatus === 'all' ? true : d.status === donFilterStatus;
        const q = donSearchText.trim().toLowerCase();
        const okSearch = !q ? true : (d.donor.toLowerCase().includes(q) || (d.eventName || '').toLowerCase().includes(q));
        return okStatus && okSearch;
      });
      
      if (e.target.checked) {
        visibleDonations.forEach(d => selectedDonations.add(d._id));
      } else {
        visibleDonations.forEach(d => selectedDonations.delete(d._id));
      }
      renderDonations();
    });

    // Handle individual donation checkboxes
    donTbody.addEventListener('change', (e) => {
      if (e.target.classList.contains('donation-checkbox')) {
        const id = e.target.dataset.id;
        if (e.target.checked) {
          selectedDonations.add(id);
        } else {
          selectedDonations.delete(id);
        }
        updateDonationSelectAllCheckbox();
      }
    });

    function updateDonationSelectAllCheckbox() {
      const visibleDonations = donations.filter(d => {
        const okStatus = donFilterStatus === 'all' ? true : d.status === donFilterStatus;
        const q = donSearchText.trim().toLowerCase();
        const okSearch = !q ? true : (d.donor.toLowerCase().includes(q) || (d.eventName || '').toLowerCase().includes(q));
        return okStatus && okSearch;
      });
      
      const visibleIds = visibleDonations.map(d => d._id);
      const selectedVisible = visibleIds.filter(id => selectedDonations.has(id));
      
      if (selectedVisible.length === 0) {
        donSelectAllCheckbox.checked = false;
        donSelectAllCheckbox.indeterminate = false;
      } else if (selectedVisible.length === visibleIds.length) {
        donSelectAllCheckbox.checked = true;
        donSelectAllCheckbox.indeterminate = false;
      } else {
        donSelectAllCheckbox.checked = false;
        donSelectAllCheckbox.indeterminate = true;
      }
    }

    // Expenses selection functionality
    expSelectAllBtn.addEventListener('click', () => {
      const visibleExpenses = expenses.filter(e => {
        const okStatus = expFilterStatus === 'all' ? true : e.status === expFilterStatus;
        const q = expSearchText.trim().toLowerCase();
        const okSearch = !q ? true : (e.recipient.toLowerCase().includes(q) || (e.purpose || '').toLowerCase().includes(q));
        return okStatus && okSearch;
      });
      
      visibleExpenses.forEach(e => selectedExpenses.add(e._id));
      renderExpenses();
      updateExpenseSelectAllCheckbox();
    });

    expDeselectAllBtn.addEventListener('click', () => {
      selectedExpenses.clear();
      renderExpenses();
      updateExpenseSelectAllCheckbox();
    });

    expSelectAllCheckbox.addEventListener('change', (e) => {
      const visibleExpenses = expenses.filter(exp => {
        const okStatus = expFilterStatus === 'all' ? true : exp.status === expFilterStatus;
        const q = expSearchText.trim().toLowerCase();
        const okSearch = !q ? true : (exp.recipient.toLowerCase().includes(q) || (exp.purpose || '').toLowerCase().includes(q));
        return okStatus && okSearch;
      });
      
      if (e.target.checked) {
        visibleExpenses.forEach(exp => selectedExpenses.add(exp._id));
      } else {
        visibleExpenses.forEach(exp => selectedExpenses.delete(exp._id));
      }
      renderExpenses();
    });

    // Handle individual expense checkboxes
    expTbody.addEventListener('change', (e) => {
      if (e.target.classList.contains('expense-checkbox')) {
        const id = e.target.dataset.id;
        if (e.target.checked) {
          selectedExpenses.add(id);
        } else {
          selectedExpenses.delete(id);
        }
        updateExpenseSelectAllCheckbox();
      }
    });

    function updateExpenseSelectAllCheckbox() {
      const visibleExpenses = expenses.filter(e => {
        const okStatus = expFilterStatus === 'all' ? true : e.status === expFilterStatus;
        const q = expSearchText.trim().toLowerCase();
        const okSearch = !q ? true : (e.recipient.toLowerCase().includes(q) || (e.purpose || '').toLowerCase().includes(q));
        return okStatus && okSearch;
      });
      
      const visibleIds = visibleExpenses.map(e => e._id);
      const selectedVisible = visibleIds.filter(id => selectedExpenses.has(id));
      
      if (selectedVisible.length === 0) {
        expSelectAllCheckbox.checked = false;
        expSelectAllCheckbox.indeterminate = false;
      } else if (selectedVisible.length === visibleIds.length) {
        expSelectAllCheckbox.checked = true;
        expSelectAllCheckbox.indeterminate = false;
      } else {
        expSelectAllCheckbox.checked = false;
        expSelectAllCheckbox.indeterminate = true;
      }
    }
  });
</script>
</body>
</html>